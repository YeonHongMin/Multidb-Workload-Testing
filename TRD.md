# 기술 요구서 (TRD)
# 멀티 데이터베이스 워크로드 테스트 도구

## 문서 정보
| 항목 | 설명 |
|------|-------------|
| 문서 버전 | 1.0 |
| 프로젝트 이름 | 멀티 데이터베이스 워크로드 테스트 도구 |
| 현재 버전 | v2.3 |
| 최종 업데이트 | 2025-12-29 |
| 문서 관리자 | 개발팀 |

---

## 1. 개요

### 1.1 목적
이 문서는 Python을 통해 JDBC 드라이버를 사용하여 Oracle, PostgreSQL, MySQL, SQL Server, Tibero, IBM DB2를 지원하는 고성능 멀티 데이터베이스 부하 테스트 도구의 기술 요구사항을 정의합니다.

### 1.2 범위
이 도구는 다음과 같은 기능을 제공하도록 설계되었습니다:
- 구성 가능한 스레드 수로 동시 데이터베이스 워크로드 테스트 수행
- 통합 JDBC 인터페이스를 통한 다양한 데이터베이스 시스템 지원
- 실시간 성능 모니터링 및 통계 제공
- 자동 재연결을 통한 데이터베이스 복원력 테스트
- 다양한 워크로드 지원 (INSERT, SELECT, UPDATE, DELETE, 혼합)
- 여러 형식으로 결과 내보내기 (CSV, JSON)

### 1.3 대상 사용자
- 데이터베이스 관리자
- 성능 엔지니어
- DevOps 팀
- 품질 보증 엔지니어

---

## 2. 시스템 개요

### 2.1 아키텍처
```
┌─────────────────────────────────────────────────────────────┐
│                    Python 애플리케이션 계층              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │ 부하 테스트    │  │ 연결 풀       │  │ 성능          │       │
│  │ 워커          │  │              │  │ 카운터       │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                  JayDeBeApi / JPype1 계층                  │
│                    (Python-JDBC 브리지)                    │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                     JDBC 드라이버 계층                      │
│  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐  │
│  │Oracle│ │PostgreSQL│ │MySQL│ │SQLSrv│ │Tibero│ │ DB2 │  │
│  └──────┘ └──────┘ └──────┘ └──────┘ └──────┘ └──────┘  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   데이터베이스 서버                          │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 핵심 구성요소

#### 2.2.1 핵심 모듈
1. **데이터베이스 어댑터**
   - OracleJDBCAdapter
   - PostgreSQLJDBCAdapter
   - MySQLJDBCAdapter
   - SQLServerJDBCAdapter
   - TiberoJDBCAdapter
   - DB2JDBCAdapter

2. **연결 풀**
   - 고급 기능을 갖춘 JDBCConnectionPool
   - 초기화 시 풀 웜업
   - 연결 누수 감지
   - 최대 수명 관리
   - 유휴 상태 헬스 체크

3. **성능 모니터링**
   - 서브초 단위 메트릭을 갖춘 PerformanceCounter
   - 실시간 TPS 계산
   - 레이턴시 통계 (P50/P95/P99)
   - 시계열 데이터 기록

4. **부하 테스트 워커**
   - 멀티스레드 워크로드 실행
   - 실패 시 자동 재연결
   - 지수적 백오프를 통한 재시도
   - 우아한 저하(Graceful Degradation)

5. **속도 제한기**
   - 토큰 버킷 알고리즘
   - 구성 가능한 목표 TPS
   - 버스트 허용량

### 2.3 기술 스택

| 계층 | 기술 |
|-------|------------|
| 프로그래밍 언어 | Python 3.10+ |
| JVM | Java JDK 17+ |
| JDBC 브리지 | JayDeBeApi, JPype1 |
| 데이터베이스 드라이버 | 네이티브 JDBC 드라이버 |
| 동시성 | Python threading, ThreadPoolExecutor |
| 로깅 | Python logging 모듈 |

---

## 3. 기능 요구사항

### 3.1 데이터베이스 지원 (FR-001)
시스템은 다음 데이터베이스를 지원해야 합니다:

| 데이터베이스 | 버전 | 포트 | JDBC 드라이버 |
|----------|---------|------|-------------|
| Oracle | 19c+ | 1521 | ojdbc*.jar |
| PostgreSQL | 11+ | 5432 | postgresql-*.jar |
| MySQL | 5.7+ | 3306 | mysql-connector-*.jar |
| SQL Server | 2016+ | 1433 | mssql-jdbc-*.jar |
| Tibero | 6+ | 8629 | tibero*.jdbc*.jar |
| IBM DB2 | - | 50000 | db2jcc*.jar |

### 3.2 작업 모드 (FR-002)

| 모드 | 설명 | 작업 |
|------|-------------|------------|
| full | 완전한 CRUD 사이클 | INSERT → SELECT → VERIFY → UPDATE → DELETE |
| insert-only | 쓰기 성능 테스트 | INSERT → COMMIT |
| select-only | 읽기 성능 테스트 | SELECT만 |
| update-only | 업데이트 성능 테스트 | UPDATE → COMMIT |
| delete-only | 삭제 성능 테스트 | DELETE → COMMIT |
| mixed | 실제 워크로드 시뮬레이션 | INSERT (60%) / SELECT (20%) / UPDATE (15%) / DELETE (5%) |

### 3.3 연결 풀링 (FR-003)

#### FR-003.1: 기본 풀 구성
- 최소 풀 크기: 100 (구성 가능)
- 최대 풀 크기: 200 (구성 가능)
- MySQL 특수 제한: 32 (Connector/J 특성으로 인한 제한)

#### FR-003.2: 고급 풀 기능
- **풀 웜업**: 초기화 시 min_size만큼 연결 생성
- **연결 누수 감지**: 60초 후 경고 (구성 가능)
- **최대 수명**: 1800초 후 연결 재활용 (구성 가능)
- **유휴 헬스 체크**: 30초마다 유효성 검사 (구성 가능)
- **유휴 타임아웃**: 30초 후 유휴 연결 제거 (구성 가능)
- **킵얼라이브**: 30초마다 연결 유효성 검사 (구성 가능)
- **연결 타임아웃**: 로그인 10초 (구성 가능)

#### FR-003.3: 풀 통계
시스템은 다음을 추적하고 보고해야 합니다:
- 총 연결 수
- 활성 연결 수
- 유휴 연결 수
- 총 생성된 연결 수
- 재활용된 연결 수
- 누수 경고 수

### 3.4 성능 메트릭 (FR-004)

#### FR-004.1: 트랜잭션 메트릭
- 총 트랜잭션 수
- INSERT 작업 수
- SELECT 작업 수
- UPDATE 작업 수
- DELETE 작업 수
- 에러 수
- 검증 실패 수
- 연결 재생성 수

#### FR-004.2: TPS (초당 트랜잭션 수)
- **평균 TPS**: 테스트 시작부터 전체 평균
- **워밍업 후 TPS**: 워밍업 기간 이후 평균
- **실시간 TPS**: 마지막 1초 동안 TPS (서브초 윈도우)

#### FR-004.3: 레이턴시 메트릭
- 평균 레이턴시 (ms)
- P50 레이턴시 (중앙값, ms)
- P95 레이턴시 (95번째 백분위수, ms)
- P99 레이턴시 (99번째 백분위수, ms)
- 최소 레이턴시 (ms)
- 최대 레이턴시 (ms)

### 3.5 테스트 제어 기능 (FR-005)

#### FR-005.1: 워밍업 기간
- 구성 가능한 워밍업 기간 (기본값: 30초)
- 워밍업 중 평균 TPS 계산에서 통계 제외
- 워밍업 완료 표시기

#### FR-005.2: 램프업 기간
- 구성 가능한 램프업 기간 (기본값: 0 = 비활성)
- 점진적 워커 스레드 활성화
- 균등하게 분산된 워커 시작 시간

#### FR-005.3: 속도 제한
- 구성 가능한 목표 TPS (기본값: 0 = 무제한)
- 토큰 버킷 알고리즘 구현
- 목표 TPS의 최대 2배 버스트 허용
- 목표 초과 시 우아한 스로틀링

#### FR-005.4: 배치 작업
- 구성 가능한 INSERT 배치 크기 (기본값: 1)
- 배치당 단일 트랜잭션
- 배치별 랜덤 데이터 생성

### 3.6 복원력 기능 (FR-006)

#### FR-006.1: 자동 재연결
- 지수적 백오프로 최대 3회 재시도
- 초기 백오프: 100ms
- 최대 백오프: 연결 생성 2000ms, 워커 작업 5000ms
- 재시도 시도의 상세 로깅

#### FR-006.2: DB 재시작 복구
- 데이터베이스 재시작 시 연결 손실 감지
- 복구 시 자동 풀 재구축
- 성공적인 재연결 후 워커 스레드 작업 재개
- 다운타임 중 무한 루프 방지

#### FR-006.3: 우아한 종료
- SIGINT (Ctrl+C) 및 SIGTERM 신호 처리
- 종료 전 진행 중인 트랜잭션 완료
- 모든 연결 적절히 종료
- 종료 전 최종 결과 내보내기

### 3.7 결과 내보내기 (FR-007)

#### FR-007.1: CSV 형식
- 구성 헤더 섹션
- 최종 통계 섹션
- 모든 메트릭이 포함된 시계열 데이터
- 쉼표로 구분된 값

#### FR-007.2: JSON 형식
- 테스트 메타데이터 (타임스탬프, 버전)
- 구성 매개변수
- 최종 통계
- 레이턴시 통계
- 완전한 시계열 데이터
- 가독성을 위한 들여쓰기

### 3.8 스키마 관리 (FR-008)

#### FR-008.1: 자동 스키마 생성
- 각 데이터베이스에 적절한 데이터 타입으로 테이블 생성
- 기본 키 제약 조건 생성
- thread_id 및 created_at에 인덱스 생성
- 지원되는 경우 테이블 파티셔닝 (HASH 파티셔닝, 16개 파티션)

#### FR-008.2: 테이블 자르기
- 모든 테이블 데이터 지우기
- 시퀀스/식별자를 1로 재설정
- 테이블 구조 및 인덱스 보존

---

## 4. 비기능적 요구사항

### 4.1 성능 (NFR-001)

| 메트릭 | 요구사항 |
|--------|-------------|
| 최대 동시 스레드 | 1000 |
| 서브초 측정 윈도우 | 100ms (구성 가능) |
| 연결 풀 웜업 시간 | 100개 연결에 < 5초 |
| 모니터링 간격 | 1초 (구성 가능) |
| 지원 TPS 범위 | 1-10000+ |

### 4.2 신뢰성 (NFR-002)

| 요구사항 | 설명 |
|-------------|-------------|
| 연결 누수 감지 | 60초 임계값 후 경고 |
| 연결 수명 | 30분 후 자동 재활용 |
| 헬스 체크 간격 | 30초마다 |
| 에러 복구 | 지수적 백오프를 통한 자동 재시도 |
| 우아한 종료 | 진행 중인 트랜잭션 완료 |

### 4.3 확장성 (NFR-003)
- 최대 1000개의 동시 워커 스레드 지원
- 구성 가능한 연결 풀 크기 (100-1000)
- 여러 테스트 인스턴스를 통한 수평 확장
- 효율적인 리소스 관리

### 4.4 사용성 (NFR-004)
- 포괄적인 도움말이 포함된 명령줄 인터페이스
- 실시간 진행 상황 모니터링
- 맥락이 포함된 명확한 에러 메시지
- 다중 출력 형식 (콘솔, CSV, JSON)
- 각 데이터베이스별 사용 예제 스크립트

### 4.5 유지보수성 (NFR-005)
- 별도의 데이터베이스 어댑터를 갖춘 모듈형 아키텍처
- 포괄적인 인라인 문서화
- 함수 서명에 대한 타입 힌트
- 모든 구성요소 간 일관된 로깅
- 버전 제어된 구성

---

## 5. 보안 요구사항

### 5.1 인증 (SR-001)
- 데이터베이스 사용자명/비밀번호 인증 지원
- 안전한 비밀번호 처리 (평문 로깅 없음)
- 환경 변수 지원

### 5.2 연결 보안 (SR-002)
- SSL/TLS 연결 지원 (JDBC 드라이버 구성 통해)
- 해결 방지를 위한 구성 가능한 연결 타임아웃
- 네트워크 타임아웃 구성 지원

---

## 6. 데이터 요구사항

### 6.1 테스트 데이터 구조
```python
{
    "id": "기본 키 (BIGINT/NUMBER)",
    "thread_id": "워커 스레드 식별자 (VARCHAR)",
    "value_col": "테스트 값 (VARCHAR)",
    "random_data": "랜덤 문자열 데이터 (VARCHAR, 1000자)",
    "status": "레코드 상태 (VARCHAR, 기본값 'ACTIVE')",
    "created_at": "생성 타임스탬프 (TIMESTAMP)",
    "updated_at": "업데이트 타임스탬프 (TIMESTAMP)"
}
```

### 6.2 시계열 데이터
모니터링 간격마다 기록:
- 타임스탬프
- 경과 시간(초)
- 모든 트랜잭션 수
- TPS 값
- 레이턴시 통계
- 풀 통계
- 워밍업 상태

---

## 7. 인터페이스 요구사항

### 7.1 명령줄 인터페이스

#### 필수 인수
- `--db-type`: 데이터베이스 유형
- `--host`: 데이터베이스 호스트
- `--user`: 데이터베이스 사용자명
- `--password`: 데이터베이스 비밀번호

#### 연결 옵션
- `--port`: 포트 번호
- `--database`: 데이터베이스 이름 (PostgreSQL, MySQL, SQL Server, DB2)
- `--sid`: Oracle/Tibero SID
- `--service-name`: Oracle 서비스 이름
- `--jre-dir`: JDBC 드라이버 디렉터리

#### 풀 구성
- `--min-pool-size`: 최소 풀 크기 (기본값: 100)
- `--max-pool-size`: 최대 풀 크기 (기본값: 200)
- `--max-lifetime`: 연결 최대 수명(초) (기본값: 1800)
- `--leak-detection-threshold`: 누수 감지 임계값(초) (기본값: 60)
- `--idle-check-interval`: 헬스 체크 간격(초) (기본값: 30)
- `--idle-timeout`: 유휴 연결 타임아웃(초) (기본값: 30)
- `--keepalive-time`: 킵얼라이브 간격(초) (기본값: 30)
- `--connection-timeout`: 연결 타임아웃(초) (기본값: 10)

#### 테스트 구성
- `--thread-count`: 워커 스레드 수 (기본값: 100)
- `--test-duration`: 테스트 기간(초) (기본값: 300)
- `--mode`: 작업 모드 (기본값: full)
- `--skip-schema-setup`: 자동 스키마 생성 건너뛰기
- `--truncate`: 테스트 전 테이블 자르기

#### 고급 테스트 옵션
- `--warmup`: 워밍업 기간(초) (기본값: 30)
- `--ramp-up`: 램프업 기간(초) (기본값: 0)
- `--target-tps`: 목표 TPS 제한 (기본값: 0 = 무제한)
- `--batch-size`: INSERT 배치 크기 (기본값: 1)

#### 모니터링 옵션
- `--monitor-interval`: 모니터링 출력 간격(초) (기본값: 1.0)
- `--sub-second-interval`: 서브초 측정 윈도우(ms) (기본값: 100)

#### 출력 옵션
- `--output-format`: 출력 형식 (csv, json)
- `--output-file`: 출력 파일 경로

#### 일반 옵션
- `--log-level`: 로깅 레벨 (DEBUG, INFO, WARNING, ERROR)
- `--print-ddl`: DDL 출력 후 종료
- `--version`: 버전 표시 후 종료

---

## 8. 시스템 제약사항

### 8.1 하드웨어 요구사항
- **최소**: 2 CPU 코어, 4GB RAM
- **권장**: 4+ CPU 코어, 8GB+ RAM

### 8.2 소프트웨어 요구사항
- **Python**: 3.10 이상
- **Java**: JDK 17 이상
- **운영 체제**: Linux, Windows, macOS

### 8.3 네트워크 요구사항
- 데이터베이스 서버로의 네트워크 연결성
- 구성 가능한 방화벽 포트
- 예상 워크로드에 적합한 충분한 대역폭

### 8.4 데이터베이스 서버 요구사항
- 충분한 연결: max_connections >= thread_count + 버퍼
- 테스트 데이터에 적합한 충분한 스토리지
- 높은 동시성을 위한 적절한 데이터베이스 구성

---

## 9. 가정 및 종속성

### 9.1 가정
- 데이터베이스 서버가 운영 중이며 접근 가능
- 사용자가 필요한 데이터베이스 권한을 가짐 (CREATE TABLE, INSERT, SELECT, UPDATE, DELETE)
- JDBC 드라이버가 지정된 디렉터리에 있음
- JVM이 설치되어 접근 가능

### 9.2 종속성
- Python 패키지: jaydebeapi, JPype1
- 데이터베이스별 JDBC 드라이버
- 우아한 종료를 위한 시스템 신호 처리

---

## 10. 용어집

| 용어 | 정의 |
|------|------------|
| TPS | 초당 트랜잭션 수 |
| JDBC | Java Database Connectivity |
| 풀 웜업 | 초기화 시 연결 미리 생성 |
| 연결 누수 | 획득되었지만 반환되지 않은 연결 |
| 지수적 백오프 | 재시도 시도 사이 증가하는 지연 |
| P50/P95/P99 | 50번째, 95번째, 99번째 백분위수 레이턴시 |
| 램프업 | 동시 워커의 점진적 증가 |
| 토큰 버킷 | 속도 제한을 위한 알고리즘 |
| 우아한 종료 | 데이터 손실 없이 깔끔한 종료 |

---

## 11. 변경 이력

| 버전 | 날짜 | 작성자 | 변경사항 |
|---------|------|--------|---------|
| 1.0 | 2025-12-29 | 개발팀 | 초기 TRD 생성 |

---

## 부록 A: 데이터베이스별 참고사항

### A.1 Oracle
- 자동 증가를 위해 SEQUENCE 사용
- SID 및 서비스 이름 연결 모두 지원
- HASH 파티셔닝 (16개 파티션)
- LOCAL 인덱스 사용

### A.2 PostgreSQL
- 자동 증가를 위해 BIGSERIAL 사용
- HASH 파티셔닝 (16개 파티션)
- 시퀀스 재설정을 위해 RESTART IDENTITY

### A.3 MySQL
- 자동 증가를 위해 AUTO_INCREMENT 사용
- HASH 파티셔닝 (16개 파티션)
- 기본적으로 32로 제한된 풀 크기

### A.4 SQL Server
- 자동 증가를 위해 IDENTITY(1,1) 사용
- 이 버전에서는 네이티브 파티셔닝 없음
- 마지막 INSERT ID를 위해 SCOPE_IDENTITY() 사용

### A.5 Tibero
- Oracle 구문과 호환
- 자동 증가를 위해 SEQUENCE 사용
- HASH 파티셔닝 (16개 파티션)

### A.6 IBM DB2
- SEQUENCE 사용
- 이 버전에서는 네이티브 파티셔닝 없음
- NEXT VALUE FOR 및 PREVIOUS VALUE FOR 사용

---

## 부록 B: 에러 처리 전략

### B.1 연결 에러
- 지수적 백오프로 재시도 (최대 3회)
- 상세한 에러 메시지 로깅
- 무효한 연결 폐기
- 실패 보고 전 재연결 시도

### B.2 트랜잭션 에러
- 실패 시 롤백
- 에러 카운터 증가
- 작업 맥락과 함께 로깅
- 다음 트랜잭션 계속

### B.3 풀 고갈
- 한계에 근접 시 경고 로그
- 대기 기반 큐 구현
- 동적 풀 확장 고려 (향후 개선)

---

## 부록 C: 로깅 전략

### C.1 로깅 레벨
- **DEBUG**: 상세한 진단 정보
- **INFO**: 일반적인 진행 정보
- **WARNING**: 잠재적 문제 (누수 감지, 연결 실패)
- **ERROR**: 테스트 실행에 영향을 미치는 실패

### C.2 로그 파일
- **main**: multi_db_load_test_jdbc.log (INFO 및 이하)
- **error**: multi_db_load_test_jdbc_error.log (WARNING 및 이상)
- **console**: 실시간 진행 모니터링 (HH:MM:SS 형식)

### C.3 로그 형식
- 파일: YYYY-MM-DD HH:MM:SS - 메시지
- 콘솔: HH:MM:SS - 메시지

---

**문서 종료**
